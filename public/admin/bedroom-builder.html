<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bedrooms Builder - Admin AdrianLAB</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; margin: 0; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; background: #1e293b; border-radius: 12px; padding: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
    h1 { margin: 0 0 8px; }
    .subtitle { margin: 0 0 20px; color: #94a3b8; font-size: 14px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .panel { background: #0f172a; border: 1px solid #334155; border-radius: 10px; padding: 16px; }
    label { display: block; margin-bottom: 6px; color: #cbd5e1; font-weight: 600; font-size: 13px; }
    input, textarea { width: 100%; padding: 10px; border: 1px solid #475569; border-radius: 6px; background: #0b1220; color: #e2e8f0; box-sizing: border-box; }
    input:focus, textarea:focus { outline: 2px solid #818cf8; border-color: #818cf8; }
    .row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .btn { padding: 10px 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .btn-primary { background: #6366f1; color: white; }
    .btn-secondary { background: #334155; color: #e2e8f0; }
    .btn-danger { background: #ef4444; color: white; }
    .list { margin-top: 10px; display: grid; gap: 10px; }
    .item { border: 1px solid #334155; border-radius: 8px; padding: 10px; background: #0b1220; cursor: move; position: relative; }
    .item.dragging { opacity: 0.5; border-color: #818cf8; }
    .item.drag-over { border-color: #818cf8; border-style: dashed; }
    .small { font-size: 12px; color: #94a3b8; }
    .preview { background: #0b1220; border: 1px dashed #334155; border-radius: 8px; padding: 10px; min-height: 200px; display: flex; align-items: center; justify-content: center; }
    .url-box { background: #0b1220; border: 1px solid #334155; border-radius: 8px; padding: 10px; font-family: monospace; font-size: 12px; word-break: break-all; color: #a5b4fc; }
    .actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .badge { display: inline-block; background: #334155; color: #cbd5e1; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 6px; }
    .chip-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip { background: #0b1220; border: 1px solid #334155; border-radius: 999px; padding: 6px 10px; font-size: 12px; cursor: pointer; color: #e2e8f0; }
    .chip:hover { border-color: #818cf8; color: #c7d2fe; }
    .chip.selected { background: #6366f1; border-color: #6366f1; color: white; }
    .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 8px; }
    .item-actions { display: flex; gap: 6px; }
    .btn-ghost { background: #1e293b; color: #e2e8f0; border: 1px solid #334155; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
    .btn-ghost:hover { border-color: #818cf8; color: #c7d2fe; }
    .stack-note { color: #94a3b8; font-size: 12px; margin-top: 6px; }
    .canvas-container { position: relative; background: #0b1220; border: 2px solid #334155; border-radius: 8px; overflow: auto; margin-top: 10px; padding: 0; }
    #canvas { display: block; cursor: crosshair; max-width: 100%; image-rendering: pixelated; margin: 0; padding: 0; }
    .canvas-overlay { position: absolute; top: 0; left: 0; pointer-events: none; margin: 0; padding: 0; }
    .canvas-element { position: absolute; border: 2px solid #818cf8; background: rgba(99, 102, 241, 0.1); cursor: move; pointer-events: all; }
    .canvas-element.selected { border-color: #fbbf24; background: rgba(251, 191, 36, 0.2); }
    .canvas-element:hover { border-color: #c7d2fe; }
    .canvas-element.locked { pointer-events: none !important; }
    .canvas-element-label { position: absolute; top: -20px; left: 0; background: #1e293b; color: #e2e8f0; padding: 2px 6px; font-size: 10px; border-radius: 4px; white-space: nowrap; }
    .select-all-container { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; padding: 8px; background: #0b1220; border-radius: 6px; }
    .select-all-container input[type="checkbox"] { width: auto; margin: 0; }
    .drag-handle { cursor: grab; padding: 4px 8px; color: #94a3b8; }
    .drag-handle:active { cursor: grabbing; }
    .full-width { grid-column: 1 / -1; }
    .item.locked { opacity: 0.7; background: #1a2332; }
    .item.locked input { background: #0a0f1a; cursor: not-allowed; }
    .lock-btn { background: #1e293b; color: #e2e8f0; border: 1px solid #334155; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
    .lock-btn:hover { border-color: #818cf8; color: #c7d2fe; }
    .lock-btn.locked { background: #fbbf24; border-color: #fbbf24; color: #1e293b; }
    .lock-btn.locked:hover { background: #f59e0b; border-color: #f59e0b; }
    .canvas-element.locked { border-color: #fbbf24 !important; opacity: 0.8; cursor: not-allowed; pointer-events: none !important; }
    .canvas-element.locked:hover { border-color: #f59e0b !important; }
  </style>
</head>
<body>
  <div class="container">
    <div style="display:flex; justify-content: space-between; align-items: center;">
      <div>
        <h1>Bedrooms Builder</h1>
        <p class="subtitle">Probar composici√≥n de dormitorio con AdrianZERO y objetos extra</p>
      </div>
      <a href="/admin" class="btn btn-secondary" style="text-decoration:none;">‚Üê Admin</a>
    </div>

    <div class="grid">
      <div class="panel">
        <h3>Configuraci√≥n base</h3>
        <label>AdrianZERO Token ID</label>
        <input id="tokenId" type="number" placeholder="ej. 146" value="">
        <div class="row" style="margin-top:10px;">
          <div>
            <label>Pos X (ax)</label>
            <input id="ax" type="number" value="40">
          </div>
          <div>
            <label>Pos Y (ay)</label>
            <input id="ay" type="number" value="90">
          </div>
          <div>
            <label>Escala (ascale)</label>
            <input id="ascale" type="number" step="0.01" value="0.45">
          </div>
        </div>
        <p class="small" style="margin-top:8px;">Lienzo: bedroom assets (1500 √ó 496). Posici√≥n/escala en px relativas al lienzo.</p>
      </div>

      <div style="display:flex; flex-direction:column; gap:20px;">
        <div class="panel">
          <h3>Assets r√°pidos</h3>
          <div class="select-all-container">
            <input type="checkbox" id="select-all-assets" onchange="toggleSelectAll()">
            <label for="select-all-assets" style="margin:0; cursor:pointer;">Seleccionar todos</label>
          </div>
          <p class="small">Click para a√±adir capa. Arrastra en el canvas para posicionar.</p>
          <div class="chip-list" id="quick-assets"></div>
          <div class="actions" style="margin-top:10px;">
            <button class="btn btn-secondary" onclick="addSelectedAssets()">A√±adir seleccionados</button>
            <button class="btn btn-secondary" onclick="applyBasePreset()">Cargar pack base</button>
            <button class="btn btn-secondary" onclick="resetExtrasOnly()">Limpiar extras</button>
          </div>
        </div>

        <div class="panel">
          <h3>Extras (arrastra para reordenar)</h3>
          <p class="small">El orden define el z-index. Arrastra elementos en la lista o en el canvas.</p>
          <div class="list" id="extras-list"></div>
          <button class="btn btn-secondary" onclick="addExtra()">+ A√±adir extra</button>
        </div>
      </div>
    </div>

    <div class="panel full-width" style="margin-top:20px;">
      <h3>Canvas interactivo</h3>
      <p class="small">Arrastra los elementos en el canvas para moverlos. Las coordenadas se actualizan autom√°ticamente.</p>
      <div class="canvas-container" id="canvas-container">
        <canvas id="canvas"></canvas>
        <div id="canvas-overlay" class="canvas-overlay"></div>
      </div>
    </div>

    <div class="panel" style="margin-top:20px;">
      <h3>URL generada <span class="badge">GET /api/bedrooms</span></h3>
      <div class="url-box" id="url-box">Completa los campos para generar URL</div>
      <div class="actions">
        <button class="btn btn-primary" onclick="generate()">Generar preview</button>
        <button class="btn btn-secondary" onclick="copyUrl()">Copiar URL</button>
        <button class="btn btn-danger" onclick="resetState()">Reset</button>
      </div>
    </div>

    <div class="panel" style="margin-top:20px;">
      <h3>Preview</h3>
      <div class="preview" id="preview">Sin preview</div>
    </div>
  </div>

  <script>
    const basePreset = [
      { id: 'bedrooms/assets/Layer_3_Floor.png', x: 0, y: 0, scale: 1 },
      { id: 'bedrooms/assets/Layer_2.png', x: 0, y: 0, scale: 1 },
      { id: 'bedrooms/assets/Window_1.png', x: 0, y: 0, scale: 1 },
      { id: 'bedrooms/assets/Layer4_Window-Its_Ok.png', x: 0, y: 0, scale: 1 },
    ];

    const quickAssets = [
      { id: 'bedrooms/assets/Layer_3_Floor.png', label: 'Layer 3 Floor' },
      { id: 'bedrooms/assets/Layer_2.png', label: 'Layer 2' },
      { id: 'bedrooms/assets/Window_1.png', label: 'Window 1' },
      { id: 'bedrooms/assets/Layer4_Window-Its_Ok.png', label: 'Window Overlay' },
      { id: 'bedrooms/assets/Board_Left.png', label: 'Board Left' },
      { id: 'bedrooms/assets/Board_Right.png', label: 'Board Right' },
      { id: 'bedrooms/assets/Desk_1.png', label: 'Desk 1' },
      { id: 'bedrooms/assets/Desk_2.png', label: 'Desk 2' },
      { id: 'bedrooms/assets/Lamp.png', label: 'Lamp' },
      { id: 'bedrooms/assets/Boom-Box.png', label: 'Boom Box' },
      { id: 'bedrooms/assets/OG_Poster.png', label: 'OG Poster' },
      { id: 'bedrooms/assets/Trophy_Golden_Floppy.png', label: 'Trophy Golden' },
      { id: 'bedrooms/assets/Trophy_XMas_Floppy.png', label: 'Trophy Xmas' }
    ];

    const state = {
      tokenId: '',
      ax: 40,
      ay: 90,
      ascale: 0.45,
      extras: basePreset.map(e => ({ ...e }))
    };

    let selectedAssets = new Set();
    let draggedElement = null;
    let dragOffset = { x: 0, y: 0 };
    let draggedItemIndex = null;
    let canvasScale = 1;
    
    // Dimensiones exactas del bedroom (deben coincidir con las im√°genes reales)
    // Las im√°genes base tienen dimensiones de 1500 x 496
    const BEDROOM_WIDTH = 1500;
    const BEDROOM_HEIGHT = 496;
    const CANVAS_WIDTH = BEDROOM_WIDTH;
    const CANVAS_HEIGHT = BEDROOM_HEIGHT;

    function loadSaved() {
      const saved = localStorage.getItem('bedroomsBuilder');
      if (saved) {
        try {
          const obj = JSON.parse(saved);
          Object.assign(state, obj);
          if (!state.extras || state.extras.length === 0) {
            state.extras = basePreset.map(e => ({ ...e }));
          }
        } catch (e) { console.warn('No se pudo cargar estado'); }
      }
    }

    function save() {
      localStorage.setItem('bedroomsBuilder', JSON.stringify(state));
    }

    function toggleSelectAll() {
      const checkbox = document.getElementById('select-all-assets');
      const allSelected = quickAssets.every(asset => selectedAssets.has(asset.id));
      
      if (allSelected) {
        selectedAssets.clear();
        quickAssets.forEach(asset => {
          const chip = document.querySelector(`[data-asset-id="${asset.id}"]`);
          if (chip) chip.classList.remove('selected');
        });
      } else {
        quickAssets.forEach(asset => {
          selectedAssets.add(asset.id);
          const chip = document.querySelector(`[data-asset-id="${asset.id}"]`);
          if (chip) chip.classList.add('selected');
        });
      }
      checkbox.checked = !allSelected;
    }

    function addSelectedAssets() {
      selectedAssets.forEach(id => {
        const asset = quickAssets.find(a => a.id === id);
        if (asset) {
          state.extras.push({ id: asset.id, x: 0, y: 0, scale: 1, locked: false });
        }
      });
      renderExtras();
      renderCanvas();
    }

    function renderExtras() {
      const list = document.getElementById('extras-list');
      list.innerHTML = '';
      state.extras.forEach((ex, idx) => {
        const div = document.createElement('div');
        const isLocked = ex.locked || false;
        div.className = `item ${isLocked ? 'locked' : ''}`;
        div.draggable = !isLocked;
        div.dataset.index = idx;
        
        div.innerHTML = `
          <div class="item-header">
            <div>
              <span class="drag-handle">‚ò∞</span>
              <strong>#${idx + 1}</strong> <span class="badge">z ${idx + 1}</span>
              ${isLocked ? '<span class="badge" style="background:#fbbf24;color:#1e293b;">üîí Bloqueado</span>' : ''}
            </div>
            <div class="item-actions">
              <button class="lock-btn ${isLocked ? 'locked' : ''}" onclick="toggleLock(${idx})" title="${isLocked ? 'Desbloquear' : 'Bloquear'}">
                ${isLocked ? 'üîì' : 'üîí'}
              </button>
              <button class="btn-ghost" onclick="moveExtra(${idx}, -1)" ${isLocked ? 'disabled' : ''}>‚Üë</button>
              <button class="btn-ghost" onclick="moveExtra(${idx}, 1)" ${isLocked ? 'disabled' : ''}>‚Üì</button>
              <button class="btn btn-danger" onclick="removeExtra(${idx})">Eliminar</button>
            </div>
          </div>
          <label>ID / Ruta</label>
          <input value="${ex.id || ''}" oninput="updateExtra(${idx}, 'id', this.value)" placeholder="p.ej. bedrooms/assets/Desk_1.png" ${isLocked ? 'disabled' : ''}>
          <div class="row" style="margin-top:8px;">
            <div>
              <label>X</label>
              <input type="number" value="${ex.x ?? 0}" oninput="updateExtra(${idx}, 'x', parseFloat(this.value)); renderCanvas();" ${isLocked ? 'disabled' : ''}>
            </div>
            <div>
              <label>Y</label>
              <input type="number" value="${ex.y ?? 0}" oninput="updateExtra(${idx}, 'y', parseFloat(this.value)); renderCanvas();" ${isLocked ? 'disabled' : ''}>
            </div>
            <div>
              <label>Escala</label>
              <input type="number" step="0.01" value="${ex.scale ?? 1}" oninput="updateExtra(${idx}, 'scale', parseFloat(this.value)); renderCanvas();" ${isLocked ? 'disabled' : ''}>
            </div>
          </div>
        `;
        
        // Drag & drop para reordenar
        div.addEventListener('dragstart', (e) => {
          draggedItemIndex = idx;
          div.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });
        
        div.addEventListener('dragend', () => {
          div.classList.remove('dragging');
          draggedItemIndex = null;
        });
        
        div.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          if (draggedItemIndex !== null && draggedItemIndex !== idx) {
            div.classList.add('drag-over');
          }
        });
        
        div.addEventListener('dragleave', () => {
          div.classList.remove('drag-over');
        });
        
        div.addEventListener('drop', (e) => {
          e.preventDefault();
          div.classList.remove('drag-over');
          if (draggedItemIndex !== null && draggedItemIndex !== idx) {
            const [item] = state.extras.splice(draggedItemIndex, 1);
            state.extras.splice(idx, 0, item);
            renderExtras();
            renderCanvas();
          }
        });
        
        list.appendChild(div);
      });
      updateUrl();
      save();
    }

    function moveExtra(idx, direction) {
      const target = idx + direction;
      if (target < 0 || target >= state.extras.length) return;
      const [item] = state.extras.splice(idx, 1);
      state.extras.splice(target, 0, item);
      renderExtras();
      renderCanvas();
    }

    function addExtra() {
      state.extras.push({ id: '', x: 0, y: 0, scale: 1, locked: false });
      renderExtras();
      renderCanvas();
    }
    
    function removeExtra(idx) {
      state.extras.splice(idx, 1);
      renderExtras();
      renderCanvas();
    }
    
    function updateExtra(idx, key, val) {
      state.extras[idx][key] = val;
      updateUrl();
      save();
    }

    function toggleLock(idx) {
      if (!state.extras[idx]) return;
      state.extras[idx].locked = !state.extras[idx].locked;
      renderExtras();
      renderCanvas();
    }

    function quickAdd(id) {
      const chip = document.querySelector(`[data-asset-id="${id}"]`);
      if (chip) {
        chip.classList.toggle('selected');
        if (chip.classList.contains('selected')) {
          selectedAssets.add(id);
        } else {
          selectedAssets.delete(id);
        }
      }
      state.extras.push({ id, x: 0, y: 0, scale: 1, locked: false });
      renderExtras();
      renderCanvas();
    }

    function resetExtrasOnly() {
      state.extras = [];
      selectedAssets.clear();
      document.getElementById('select-all-assets').checked = false;
      quickAssets.forEach(asset => {
        const chip = document.querySelector(`[data-asset-id="${asset.id}"]`);
        if (chip) chip.classList.remove('selected');
      });
      renderExtras();
      renderCanvas();
    }

    function applyBasePreset() {
      state.extras = basePreset.map(e => ({ ...e }));
      renderExtras();
      renderCanvas();
    }

    function renderQuickAssets() {
      const container = document.getElementById('quick-assets');
      container.innerHTML = '';
      quickAssets.forEach(asset => {
        const btn = document.createElement('button');
        btn.className = 'chip';
        btn.textContent = asset.label;
        btn.title = asset.id;
        btn.dataset.assetId = asset.id;
        btn.onclick = () => quickAdd(asset.id);
        container.appendChild(btn);
      });
    }

    async function renderCanvas() {
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const overlay = document.getElementById('canvas-overlay');
      
      // Establecer dimensiones del canvas (usando enteros pero manteniendo proporci√≥n exacta)
      canvas.width = CANVAS_WIDTH;
      canvas.height = CANVAS_HEIGHT;
      
      // Limpiar canvas
      ctx.fillStyle = '#0b1220';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Limpiar overlay
      overlay.innerHTML = '';
      
      // Calcular escala para que quepa en el contenedor manteniendo proporciones exactas
      const container = document.getElementById('canvas-container');
      const maxWidth = container.clientWidth - 20;
      const maxHeight = window.innerHeight * 0.6; // M√°ximo 60% de la altura de la ventana
      const scaleX = maxWidth / BEDROOM_WIDTH;
      const scaleY = maxHeight / BEDROOM_HEIGHT;
      canvasScale = Math.min(scaleX, scaleY, 1); // No escalar m√°s all√° del 100%
      
      // Renderizar elementos en el canvas (en orden de z-index)
      for (let i = 0; i < state.extras.length; i++) {
        const ex = state.extras[i];
        if (!ex.id) continue;
        
        try {
          const img = await loadImageForCanvas(ex.id);
          if (img && img.complete && img.naturalWidth > 0) {
          const x = ex.x || 0;
          const y = ex.y || 0;
          const scale = ex.scale || 1;
          const width = img.naturalWidth * scale;
          const height = img.naturalHeight * scale;
          
          // Dibujar en coordenadas exactas (el canvas HTML5 maneja autom√°ticamente elementos fuera de l√≠mites)
          ctx.drawImage(img, x, y, width, height);
            
            // Crear elemento interactivo en overlay
            const element = document.createElement('div');
            element.className = 'canvas-element';
            element.dataset.index = i;
            element.style.left = `${x * canvasScale}px`;
            element.style.top = `${y * canvasScale}px`;
            element.style.width = `${width * canvasScale}px`;
            element.style.height = `${height * canvasScale}px`;
            
            const label = document.createElement('div');
            label.className = 'canvas-element-label';
            label.textContent = `#${i + 1} ${ex.id.split('/').pop()}`;
            element.appendChild(label);
            
            // Marcar como bloqueado si corresponde
            if (ex.locked) {
              element.classList.add('locked');
              element.style.pointerEvents = 'none'; // Permitir que los clics pasen a trav√©s
              element.title = 'Capa bloqueada - Click en üîì para desbloquear';
            } else {
              // Drag & drop en canvas (solo si no est√° bloqueado)
              element.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation();
                draggedElement = element;
                // Usar el contenedor como referencia para evitar desajustes por padding/margin
                const container = document.getElementById('canvas-container');
                const containerRect = container.getBoundingClientRect();
                dragOffset.x = (e.clientX - containerRect.left) / canvasScale - x;
                dragOffset.y = (e.clientY - containerRect.top) / canvasScale - y;
                element.classList.add('selected');
              });
            }
            
            overlay.appendChild(element);
          } else {
            console.warn(`Imagen no v√°lida para ${ex.id}`);
          }
        } catch (err) {
          console.error(`No se pudo cargar ${ex.id}:`, err);
          // Mostrar placeholder en el canvas para elementos que no se cargaron
          const x = ex.x || 0;
          const y = ex.y || 0;
          const element = document.createElement('div');
          element.className = 'canvas-element';
          element.dataset.index = i;
          element.style.left = `${x * canvasScale}px`;
          element.style.top = `${y * canvasScale}px`;
          element.style.width = `100px`;
          element.style.height = `50px`;
          element.style.borderColor = '#ef4444';
          element.style.background = 'rgba(239, 68, 68, 0.2)';
          
          const label = document.createElement('div');
          label.className = 'canvas-element-label';
          label.textContent = `#${i + 1} ERROR: ${ex.id.split('/').pop()}`;
          label.style.color = '#f87171';
          element.appendChild(label);
          overlay.appendChild(element);
        }
      }
      
      // Renderizar AdrianZERO si existe
      if (state.tokenId) {
        try {
          const adrianUrl = `${location.origin}/api/render/${state.tokenId}`;
          const img = await new Promise((resolve, reject) => {
            const i = new Image();
            i.crossOrigin = 'anonymous';
            i.onload = () => resolve(i);
            i.onerror = reject;
            i.src = adrianUrl;
          });
          
          const x = state.ax || 40;
          const y = state.ay || 90;
          const scale = state.ascale || 0.45;
          const width = img.width * scale;
          const height = img.height * scale;
          
          ctx.drawImage(img, x, y, width, height);
          
          // Elemento interactivo para AdrianZERO
          const element = document.createElement('div');
          element.className = 'canvas-element';
          element.dataset.adrian = 'true';
          element.style.left = `${x * canvasScale}px`;
          element.style.top = `${y * canvasScale}px`;
          element.style.width = `${width * canvasScale}px`;
          element.style.height = `${height * canvasScale}px`;
          element.style.borderColor = '#fbbf24';
          
          const label = document.createElement('div');
          label.className = 'canvas-element-label';
          label.textContent = `AdrianZERO #${state.tokenId}`;
          element.appendChild(label);
          
          element.addEventListener('mousedown', (e) => {
            e.preventDefault();
            draggedElement = element;
            // Usar el contenedor como referencia para evitar desajustes por padding/margin
            const container = document.getElementById('canvas-container');
            const containerRect = container.getBoundingClientRect();
            dragOffset.x = (e.clientX - containerRect.left) / canvasScale - x;
            dragOffset.y = (e.clientY - containerRect.top) / canvasScale - y;
            element.classList.add('selected');
          });
          
          overlay.appendChild(element);
        } catch (err) {
          console.warn('No se pudo cargar AdrianZERO:', err);
        }
      }
      
      // Ajustar tama√±o del overlay y canvas manteniendo proporciones exactas
      const displayWidth = BEDROOM_WIDTH * canvasScale;
      const displayHeight = BEDROOM_HEIGHT * canvasScale;
      overlay.style.width = `${displayWidth}px`;
      overlay.style.height = `${displayHeight}px`;
      overlay.style.left = '0px';
      overlay.style.top = '0px';
      canvas.style.width = `${displayWidth}px`;
      canvas.style.height = `${displayHeight}px`;
      
      // Asegurar que el contenedor permita mostrar el canvas completo
      // No limitamos el tama√±o del contenedor para evitar cortes
    }

    async function loadImageForCanvas(src) {
      // Construir URL correcta seg√∫n el formato del asset
      let url;
      if (src.startsWith('http')) {
        url = src;
      } else if (src.startsWith('bedrooms/')) {
        url = `${location.origin}/labimages/${src}`;
      } else if (src.startsWith('labimages/')) {
        url = `${location.origin}/${src}`;
      } else {
        url = `${location.origin}/labimages/${src}`;
      }
      
      // Intentar cargar desde Vercel primero
      try {
        const img = await new Promise((resolve, reject) => {
          const i = new Image();
          i.crossOrigin = 'anonymous';
          
          const timeout = setTimeout(() => {
            reject(new Error(`Timeout loading ${url}`));
          }, 3000); // Reducir timeout para fallback m√°s r√°pido
          
          i.onload = () => {
            clearTimeout(timeout);
            resolve(i);
          };
          
          i.onerror = (err) => {
            clearTimeout(timeout);
            reject(new Error(`Failed to load ${url}`));
          };
          
          i.src = url;
        });
        
        return img;
      } catch (err) {
        // Si falla, intentar desde GitHub raw
        console.log(`[Bedroom Builder] Fallback a GitHub raw para ${src}`);
        const githubUrl = getGitHubLabimagesUrl(src);
        console.log(`[Bedroom Builder] Intentando cargar desde GitHub: ${githubUrl}`);
        
        try {
          const img = await new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            const timeout = setTimeout(() => {
              reject(new Error(`Timeout loading ${githubUrl}`));
            }, 10000);
            
            img.onload = () => {
              clearTimeout(timeout);
              console.log(`[Bedroom Builder] ‚úÖ Imagen cargada desde GitHub: ${src}`);
              resolve(img);
            };
            
            img.onerror = (err) => {
              clearTimeout(timeout);
              console.error(`[Bedroom Builder] ‚ùå Error loading image from GitHub ${githubUrl}:`, err);
              reject(new Error(`Failed to load ${githubUrl}`));
            };
            
            img.src = githubUrl;
          });
          
          return img;
        } catch (githubErr) {
          console.error(`[Bedroom Builder] ‚ùå Error completo cargando ${src}:`, githubErr);
          throw githubErr;
        }
      }
    }

    function getGitHubLabimagesUrl(assetPath) {
      // Construir URL de GitHub raw
      const GITHUB_OWNER = 'adriangallery';
      const GITHUB_REPO = 'AdrianLAB';
      const GITHUB_BRANCH = 'main';
      const filePath = `public/labimages/${assetPath}`;
      const encodedPath = encodeURIComponent(filePath).replace(/%2F/g, '/');
      return `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${encodedPath}`;
    }

    // Mouse events para drag & drop en canvas
    document.addEventListener('mousemove', (e) => {
      if (!draggedElement) return;
      
      // Usar el contenedor como referencia para evitar desajustes por padding/margin
      const container = document.getElementById('canvas-container');
      const containerRect = container.getBoundingClientRect();
      const x = (e.clientX - containerRect.left) / canvasScale - dragOffset.x;
      const y = (e.clientY - containerRect.top) / canvasScale - dragOffset.y;
      
      draggedElement.style.left = `${x * canvasScale}px`;
      draggedElement.style.top = `${y * canvasScale}px`;
    });

    document.addEventListener('mouseup', () => {
      if (!draggedElement) return;
      
      const canvas = document.getElementById('canvas');
      const canvasRect = canvas.getBoundingClientRect();
      
      // Calcular coordenadas usando la posici√≥n del elemento relativa al overlay
      // El overlay est√° perfectamente alineado con el canvas (top: 0, left: 0)
      const elementLeft = parseFloat(draggedElement.style.left) || 0;
      const elementTop = parseFloat(draggedElement.style.top) || 0;
      
      // Convertir de coordenadas escaladas (p√≠xeles del overlay) a coordenadas reales del canvas
      // El overlay tiene el mismo tama√±o que el canvas escalado, as√≠ que dividimos por canvasScale
      const rawX = elementLeft / canvasScale;
      const rawY = elementTop / canvasScale;
      const x = Math.round(rawX);
      const y = Math.round(rawY);
      
      // Debug: log para verificar coordenadas
      console.log(`[Debug] Elemento movido: X=${x}, Y=${y} (raw: ${rawX}, ${rawY}, scale: ${canvasScale})`);
      
      if (draggedElement.dataset.adrian === 'true') {
        state.ax = x;
        state.ay = y;
        document.getElementById('ax').value = x;
        document.getElementById('ay').value = y;
      } else {
        const idx = parseInt(draggedElement.dataset.index);
        if (idx !== undefined && state.extras[idx]) {
          state.extras[idx].x = x;
          state.extras[idx].y = y;
          const inputs = document.querySelectorAll(`#extras-list .item:nth-child(${idx + 1}) input[type="number"]`);
          if (inputs[0]) inputs[0].value = x;
          if (inputs[1]) inputs[1].value = y;
        }
      }
      
      draggedElement.classList.remove('selected');
      draggedElement = null;
      updateUrl();
      save();
      renderCanvas();
    });

    function updateUrl() {
      const { tokenId, ax, ay, ascale, extras } = state;
      const params = new URLSearchParams();
      if (tokenId) params.set('tokenId', tokenId);
      params.set('ax', ax);
      params.set('ay', ay);
      params.set('ascale', ascale);
      const extrasClean = extras
        .filter(e => e.id)
        .map(e => `${e.id}@${e.x ?? 0},${e.y ?? 0},${e.scale ?? 1}`);
      if (extrasClean.length > 0) {
        params.set('extras', extrasClean.join(','));
      }
      const url = `${location.origin}/api/bedrooms?${params.toString()}`;
      document.getElementById('url-box').textContent = url;
      return url;
    }

    async function generate() {
      const url = updateUrl();
      const preview = document.getElementById('preview');
      preview.innerHTML = '<span class="small">Generando...</span>';
      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const blob = await resp.blob();
        const imgUrl = URL.createObjectURL(blob);
        const img = document.createElement('img');
        img.src = imgUrl;
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
        preview.innerHTML = '';
        preview.appendChild(img);
      } catch (err) {
        preview.innerHTML = `<span class="small" style="color:#f87171;">Error: ${err.message}</span>`;
      }
    }

    function copyUrl() {
      const url = updateUrl();
      navigator.clipboard.writeText(url);
    }

    function resetState() {
      state.tokenId = '';
      state.ax = 40; state.ay = 90; state.ascale = 0.45;
      state.extras = basePreset.map(e => ({ ...e }));
      selectedAssets.clear();
      document.getElementById('tokenId').value = '';
      document.getElementById('ax').value = 40;
      document.getElementById('ay').value = 90;
      document.getElementById('ascale').value = 0.45;
      document.getElementById('select-all-assets').checked = false;
      quickAssets.forEach(asset => {
        const chip = document.querySelector(`[data-asset-id="${asset.id}"]`);
        if (chip) chip.classList.remove('selected');
      });
      renderExtras();
      renderCanvas();
    }

    function bindInputs() {
      document.getElementById('tokenId').value = state.tokenId || '';
      document.getElementById('ax').value = state.ax;
      document.getElementById('ay').value = state.ay;
      document.getElementById('ascale').value = state.ascale;
      document.getElementById('tokenId').addEventListener('input', e => { 
        state.tokenId = e.target.value; 
        updateUrl(); 
        save(); 
        renderCanvas();
      });
      document.getElementById('ax').addEventListener('input', e => { 
        state.ax = parseFloat(e.target.value); 
        updateUrl(); 
        save(); 
        renderCanvas();
      });
      document.getElementById('ay').addEventListener('input', e => { 
        state.ay = parseFloat(e.target.value); 
        updateUrl(); 
        save(); 
        renderCanvas();
      });
      document.getElementById('ascale').addEventListener('input', e => { 
        state.ascale = parseFloat(e.target.value); 
        updateUrl(); 
        save(); 
        renderCanvas();
      });
    }

    function init() {
      loadSaved();
      bindInputs();
      renderQuickAssets();
      renderExtras();
      renderCanvas();
      updateUrl();
      
      // Ajustar canvas al redimensionar
      window.addEventListener('resize', () => {
        renderCanvas();
      });
    }
    init();
  </script>
</body>
</html>
