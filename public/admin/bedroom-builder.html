<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bedrooms Builder - Admin AdrianLAB</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; background: #1e293b; border-radius: 12px; padding: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
    h1 { margin: 0 0 8px; }
    .subtitle { margin: 0 0 20px; color: #94a3b8; font-size: 14px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .panel { background: #0f172a; border: 1px solid #334155; border-radius: 10px; padding: 16px; }
    label { display: block; margin-bottom: 6px; color: #cbd5e1; font-weight: 600; font-size: 13px; }
    input, textarea { width: 100%; padding: 10px; border: 1px solid #475569; border-radius: 6px; background: #0b1220; color: #e2e8f0; }
    input:focus, textarea:focus { outline: 2px solid #818cf8; border-color: #818cf8; }
    .row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .btn { padding: 10px 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .btn-primary { background: #6366f1; color: white; }
    .btn-secondary { background: #334155; color: #e2e8f0; }
    .btn-danger { background: #ef4444; color: white; }
    .list { margin-top: 10px; display: grid; gap: 10px; }
    .item { border: 1px solid #334155; border-radius: 8px; padding: 10px; background: #0b1220; }
    .small { font-size: 12px; color: #94a3b8; }
    .preview { background: #0b1220; border: 1px dashed #334155; border-radius: 8px; padding: 10px; min-height: 200px; display: flex; align-items: center; justify-content: center; }
    .url-box { background: #0b1220; border: 1px solid #334155; border-radius: 8px; padding: 10px; font-family: monospace; font-size: 12px; word-break: break-all; color: #a5b4fc; }
    .actions { display: flex; gap: 10px; margin-top: 10px; }
    .badge { display: inline-block; background: #334155; color: #cbd5e1; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 6px; }
  </style>
</head>
<body>
  <div class="container">
    <div style="display:flex; justify-content: space-between; align-items: center;">
      <div>
        <h1>Bedrooms Builder</h1>
        <p class="subtitle">Probar composición de dormitorio con AdrianZERO y objetos extra (Fase 1)</p>
      </div>
      <a href="/admin" class="btn btn-secondary" style="text-decoration:none;">← Admin</a>
    </div>

    <div class="grid">
      <div class="panel">
        <h3>Configuración base</h3>
        <label>AdrianZERO Token ID</label>
        <input id="tokenId" type="number" placeholder="ej. 146" value="">
        <div class="row" style="margin-top:10px;">
          <div>
            <label>Pos X (ax)</label>
            <input id="ax" type="number" value="40">
          </div>
          <div>
            <label>Pos Y (ay)</label>
            <input id="ay" type="number" value="90">
          </div>
          <div>
            <label>Escala (ascale)</label>
            <input id="ascale" type="number" step="0.01" value="0.45">
          </div>
        </div>
        <p class="small" style="margin-top:8px;">Usa el tamaño del SVG de bedroom (1049.6 × 548.375). Posición/escala en px relativas al lienzo.</p>
      </div>

      <div class="panel">
        <h3>Extras</h3>
        <p class="small">Formato param: <code>id@x,y,scale</code> separados por coma. Ej: <code>plant@820,360,1</code></p>
        <div class="list" id="extras-list"></div>
        <button class="btn btn-secondary" onclick="addExtra()">+ Añadir extra</button>
      </div>
    </div>

    <div class="panel" style="margin-top:20px;">
      <h3>URL generada <span class="badge">GET /api/bedrooms</span></h3>
      <div class="url-box" id="url-box">Completa los campos para generar URL</div>
      <div class="actions">
        <button class="btn btn-primary" onclick="generate()">Generar preview</button>
        <button class="btn btn-secondary" onclick="copyUrl()">Copiar URL</button>
        <button class="btn btn-danger" onclick="resetState()">Reset</button>
      </div>
    </div>

    <div class="panel" style="margin-top:20px;">
      <h3>Preview</h3>
      <div class="preview" id="preview">Sin preview</div>
    </div>
  </div>

  <script>
    const state = {
      tokenId: '',
      ax: 40,
      ay: 90,
      ascale: 0.45,
      extras: []
    };

    function loadSaved() {
      const saved = localStorage.getItem('bedroomsBuilder');
      if (saved) {
        try {
          const obj = JSON.parse(saved);
          Object.assign(state, obj);
        } catch (e) { console.warn('No se pudo cargar estado'); }
      }
    }

    function save() {
      localStorage.setItem('bedroomsBuilder', JSON.stringify(state));
    }

    function renderExtras() {
      const list = document.getElementById('extras-list');
      list.innerHTML = '';
      state.extras.forEach((ex, idx) => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <label>ID / Ruta</label>
          <input value="${ex.id || ''}" oninput="updateExtra(${idx}, 'id', this.value)" placeholder="p.ej. plant.svg o custom.png">
          <div class="row" style="margin-top:8px;">
            <div>
              <label>X</label>
              <input type="number" value="${ex.x ?? 0}" oninput="updateExtra(${idx}, 'x', parseFloat(this.value))">
            </div>
            <div>
              <label>Y</label>
              <input type="number" value="${ex.y ?? 0}" oninput="updateExtra(${idx}, 'y', parseFloat(this.value))">
            </div>
            <div>
              <label>Escala</label>
              <input type="number" step="0.01" value="${ex.scale ?? 1}" oninput="updateExtra(${idx}, 'scale', parseFloat(this.value))">
            </div>
          </div>
          <button class="btn btn-danger" style="margin-top:8px;" onclick="removeExtra(${idx})">Eliminar</button>
        `;
        list.appendChild(div);
      });
      updateUrl();
      save();
    }

    function addExtra() {
      state.extras.push({ id: '', x: 0, y: 0, scale: 1 });
      renderExtras();
    }
    function removeExtra(idx) {
      state.extras.splice(idx, 1);
      renderExtras();
    }
    function updateExtra(idx, key, val) {
      state.extras[idx][key] = val;
      updateUrl();
      save();
    }

    function updateUrl() {
      const { tokenId, ax, ay, ascale, extras } = state;
      const params = new URLSearchParams();
      if (tokenId) params.set('tokenId', tokenId);
      params.set('ax', ax);
      params.set('ay', ay);
      params.set('ascale', ascale);
      const extrasClean = extras
        .filter(e => e.id)
        .map(e => `${e.id}@${e.x ?? 0},${e.y ?? 0},${e.scale ?? 1}`);
      if (extrasClean.length > 0) {
        params.set('extras', extrasClean.join(','));
      }
      const url = `${location.origin}/api/bedrooms?${params.toString()}`;
      document.getElementById('url-box').textContent = url;
      return url;
    }

    async function generate() {
      const url = updateUrl();
      const preview = document.getElementById('preview');
      preview.innerHTML = '<span class="small">Generando...</span>';
      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const blob = await resp.blob();
        const imgUrl = URL.createObjectURL(blob);
        const img = document.createElement('img');
        img.src = imgUrl;
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
        preview.innerHTML = '';
        preview.appendChild(img);
      } catch (err) {
        preview.innerHTML = `<span class="small" style="color:#f87171;">Error: ${err.message}</span>`;
      }
    }

    function copyUrl() {
      const url = updateUrl();
      navigator.clipboard.writeText(url);
    }

    function resetState() {
      state.tokenId = '';
      state.ax = 40; state.ay = 90; state.ascale = 0.45;
      state.extras = [];
      document.getElementById('tokenId').value = '';
      document.getElementById('ax').value = 40;
      document.getElementById('ay').value = 90;
      document.getElementById('ascale').value = 0.45;
      renderExtras();
    }

    function bindInputs() {
      document.getElementById('tokenId').value = state.tokenId || '';
      document.getElementById('ax').value = state.ax;
      document.getElementById('ay').value = state.ay;
      document.getElementById('ascale').value = state.ascale;
      document.getElementById('tokenId').addEventListener('input', e => { state.tokenId = e.target.value; updateUrl(); save(); });
      document.getElementById('ax').addEventListener('input', e => { state.ax = parseFloat(e.target.value); updateUrl(); save(); });
      document.getElementById('ay').addEventListener('input', e => { state.ay = parseFloat(e.target.value); updateUrl(); save(); });
      document.getElementById('ascale').addEventListener('input', e => { state.ascale = parseFloat(e.target.value); updateUrl(); save(); });
    }

    function init() {
      loadSaved();
      bindInputs();
      renderExtras();
      updateUrl();
    }
    init();
  </script>
</body>
</html>

